#!/usr/bin/env python3
"""
üéì –¢–ï–°–¢–û–í–´–ô –ë–û–¢ –° –†–ï–ê–õ–¨–ù–´–ú –û–ë–™–ï–ú–û–ú
"""

import os
import re
from datetime import datetime
from flask import Flask, request, jsonify
import requests

app = Flask(__name__)
TOKEN = os.environ.get('BOT_TOKEN', '')

# ============ –ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–ê–†–°–ò–ù–ì ============
def parse_correct(text: str):
    """–ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–∞—Ä—Å–∏—Ç —Ç–µ–º—É –∏ –æ–±—ä–µ–º"""
    original = text
    text_lower = text.lower()
    
    # 1. –ò—â–µ–º –õ–Æ–ë–£–Æ —Ü–∏—Ñ—Ä—É –∫–∞–∫ –æ–±—ä–µ–º
    volume = "3"
    volume_match = None
    
    # –í—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≥–¥–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ü–∏—Ñ—Ä–∞
    matches = re.finditer(r'\b(\d+)\b', text_lower)
    for match in matches:
        vol = match.group(1)
        if vol.isdigit() and 1 <= int(vol) <= 10:
            volume = vol
            volume_match = match.group(0)
            break
    
    # 2. –£–±–∏—Ä–∞–µ–º –æ–±—ä–µ–º
    clean_text = original
    if volume_match:
        # –ó–∞–º–µ–Ω—è–µ–º —Ü–∏—Ñ—Ä—É —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –≤–æ–∫—Ä—É–≥
        clean_text = re.sub(r'\s*' + volume_match + r'\s*', ' ', clean_text)
    
    # 3. –£–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–ª–æ–≤–∞ "–ª–∏—Å—Ç", "–ª" –µ—Å–ª–∏ –æ–Ω–∏ —Ä—è–¥–æ–º —Å —Ü–∏—Ñ—Ä–∞–º–∏
    clean_text = re.sub(r'\s*–ª–∏—Å—Ç\w*\s*', ' ', clean_text, flags=re.IGNORECASE)
    clean_text = re.sub(r'\s*–ª\s*\b', ' ', clean_text, flags=re.IGNORECASE)
    
    # 4. –£–±–∏—Ä–∞–µ–º —Ç–∏–ø—ã –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
    clean_text = re.sub(r'\b(–∫–æ–Ω—Å–ø–µ–∫—Ç|—Ä–µ—Ñ–µ—Ä–∞—Ç|—ç—Å—Å–µ)\b', '', clean_text, flags=re.IGNORECASE)
    
    # 5. –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥–ª–æ–≥–∏
    clean_text = re.sub(r'\b(–ø–æ|–æ|–Ω–∞|—Ç–µ–º–µ|—Ç–µ–º–∞|–ø—Ä–æ|–æ–±)\b', '', clean_text, flags=re.IGNORECASE)
    
    # 6. –û—á–∏—â–∞–µ–º
    topic = re.sub(r'\s+', ' ', clean_text).strip()
    
    # 7. –ï—Å–ª–∏ —Ç–µ–º–∞ –∫–æ—Ä–æ—Ç–∫–∞—è, –±–µ—Ä–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
    if len(topic) < 2:
        # –ë–µ—Ä–µ–º –≤—Å–µ –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä –∏ "–ª–∏—Å—Ç"
        words = original.split()
        filtered = []
        for word in words:
            word_lower = word.lower()
            if (not word.isdigit() and 
                '–ª–∏—Å—Ç' not in word_lower and
                word not in ['–ª', '–ª–∏—Å—Ç–∞', '–ª–∏—Å—Ç–æ–≤']):
                filtered.append(word)
        topic = ' '.join(filtered)
    
    print(f"‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: –¢–µ–º–∞='{topic}', –û–±—ä–µ–º={volume}–ª")
    return topic[:100], volume

# ============ –ì–ï–ù–ï–†–ê–¶–ò–Ø –†–ï–ê–õ–¨–ù–û–ì–û –û–ë–™–ï–ú–ê ============
def generate_real_volume(topic: str, pages: int):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –†–ï–ê–õ–¨–ù–´–ô –æ–±—ä–µ–º —Ç–µ–∫—Å—Ç–∞"""
    
    content = []
    
    # –ó–ê–ì–û–õ–û–í–û–ö
    content.append(f"üìö <b>–ö–û–ù–°–ü–ï–ö–¢: {topic.upper()}</b>")
    content.append(f"üìä <b>–û–±—ä–µ–º:</b> {pages} –ª–∏—Å—Ç(–∞/–æ–≤) –ê4")
    content.append(f"üìÖ <b>–î–∞—Ç–∞:</b> {datetime.now().strftime('%d.%m.%Y %H:%M')}")
    content.append("")
    
    # –í–í–ï–î–ï–ù–ò–ï (10-15% –æ–±—ä–µ–º–∞)
    content.append("<b>1. –í–í–ï–î–ï–ù–ò–ï</b>")
    intro = f"""–¢–µ–º–∞ ¬´{topic}¬ª –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, 
–∏–º–µ—é—â–∏–π –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö. 
–ò–∑—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω–æ–π —Ç–µ–º—ã –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥–ø–æ—Å—ã–ª–∫–∏, 
–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã —Ä–∞–∑–≤–∏—Ç–∏—è.

<b>–¶–µ–ª—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è:</b> —Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞–Ω–∏—è –ø–æ —Ç–µ–º–µ ¬´{topic}¬ª, 
–≤—ã—è–≤–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã –∏ —Å–¥–µ–ª–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –≤—ã–≤–æ–¥—ã.

<b>–ó–∞–¥–∞—á–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è:</b>
1. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å–Ω–æ–≤—ã
2. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã
3. –ò–∑—É—á–∏—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
4. –°—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏"""
    content.append(intro)
    content.append("")
    
    # –û–°–ù–û–í–ù–ê–Ø –ß–ê–°–¢–¨ (70-80% –æ–±—ä–µ–º–∞)
    content.append("<b>2. –û–°–ù–û–í–ù–ê–Ø –ß–ê–°–¢–¨</b>")
    
    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑–¥–µ–ª–æ–≤ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–±—ä–µ–º–∞
    sections_count = pages * 2  # –î–ª—è 3 –ª–∏—Å—Ç–æ–≤ = 6 —Ä–∞–∑–¥–µ–ª–æ–≤
    
    for section_num in range(1, sections_count + 1):
        content.append(f"<b>2.{section_num}. –†–ê–ó–î–ï–õ {section_num}</b>")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –º–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤ –∫–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª
        section_text = f"""–î–∞–Ω–Ω—ã–π —Ä–∞–∑–¥–µ–ª –ø–æ—Å–≤—è—â–µ–Ω –≤–∞–∂–Ω–æ–º—É –∞—Å–ø–µ–∫—Ç—É —Ç–µ–º—ã ¬´{topic}¬ª. 
–†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é—Ç—Å—è –∫–ª—é—á–µ–≤—ã–µ –ø–æ–Ω—è—Ç–∏—è, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏.

<b>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è:</b>
‚Ä¢ –ü–æ–ª–æ–∂–µ–Ω–∏–µ 1: {topic} –∏–º–µ–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –∫–æ—Ä–Ω–∏ –∏ —Ä–∞–∑–≤–∏–≤–∞–ª–∞—Å—å –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
‚Ä¢ –ü–æ–ª–æ–∂–µ–Ω–∏–µ 2: –í —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ {topic} –ø—Ä–∏–æ–±—Ä–µ—Ç–∞–µ—Ç –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏
‚Ä¢ –ü–æ–ª–æ–∂–µ–Ω–∏–µ 3: –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏–π –æ {topic} –∏–º–µ–µ—Ç —à–∏—Ä–æ–∫–∏–π —Å–ø–µ–∫—Ç—Ä –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π

<b>–ü—Ä–∏–º–µ—Ä—ã –∏ –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏:</b>
- –ü—Ä–∏–º–µ—Ä 1 –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥ –∫ –∏–∑—É—á–µ–Ω–∏—é {topic}
- –ü—Ä–∏–º–µ—Ä 2 –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏ –≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏ {topic}
- –ü—Ä–∏–º–µ—Ä 3 –∏–ª–ª—é—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π

<b>–ê–Ω–∞–ª–∏–∑ –∏ –≤—ã–≤–æ–¥—ã –ø–æ —Ä–∞–∑–¥–µ–ª—É:</b>
–ü—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É—Ç–≤–µ—Ä–∂–¥–∞—Ç—å, —á—Ç–æ –∏–∑—É—á–µ–Ω–∏–µ {topic} —Ç—Ä–µ–±—É–µ—Ç 
–∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ –∏ —É—á–µ—Ç–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É—á–∏—Ç—ã–≤–∞—Ç—å 
–∫–∞–∫ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å–Ω–æ–≤—ã, —Ç–∞–∫ –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∑–Ω–∞–Ω–∏–π."""
        
        content.append(section_text)
        content.append("")
    
    # –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï (10-15% –æ–±—ä–µ–º–∞)
    content.append("<b>3. –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï</b>")
    conclusion = f"""–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ —Ç–µ–º–µ ¬´{topic}¬ª 
–±—ã–ª–∏ –ø–æ–ª—É—á–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã:

<b>–û—Å–Ω–æ–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã:</b>
1. {topic} –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Å–ª–æ–∂–Ω—ã–π –∏ –º–Ω–æ–≥–æ–≥—Ä–∞–Ω–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
2. –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ {topic} –æ–∫–∞–∑–∞–ª–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
3. –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å–Ω–æ–≤—ã –∏–∑—É—á–µ–Ω–∏—è {topic} –≤–∫–ª—é—á–∞—é—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –∏ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏
4. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏–π –æ {topic} –∏–º–µ–µ—Ç —à–∏—Ä–æ–∫–∏–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã
5. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–∞–ª—å–Ω–µ–π—à–µ–µ —É–≥–ª—É–±–ª–µ–Ω–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ {topic}

<b>–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>
‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1: –£–≥–ª—É–±–ª–µ–Ω–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Å–Ω–æ–≤
‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2: –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π
‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 3: –ú–µ–∂–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é
‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –∞–Ω–∞–ª–∏–∑–∞

<b>–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è:</b>
–ò–∑—É—á–µ–Ω–∏–µ {topic} –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –Ω–∞—É—á–Ω—ã—Ö –∏–∑—ã—Å–∫–∞–Ω–∏–π, 
–≤–∫–ª—é—á–∞—è —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑, –∏–∑—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ."""
    
    content.append(conclusion)
    content.append("")
    
    # –ò–°–¢–û–ß–ù–ò–ö–ò
    content.append("<b>üìö –°–ü–ò–°–û–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ù–´–• –ò–°–¢–û–ß–ù–ò–ö–û–í</b>")
    sources = [
        f"1. –ù–∞—É—á–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ —Ç–µ–º–µ ¬´{topic}¬ª (2020-2024)",
        f"2. –£—á–µ–±–Ω—ã–µ –ø–æ—Å–æ–±–∏—è –∏ –º–æ–Ω–æ–≥—Ä–∞—Ñ–∏–∏ –æ {topic}",
        f"3. –°—Ç–∞—Ç—å–∏ –≤ –Ω–∞—É—á–Ω—ã—Ö –∂—É—Ä–Ω–∞–ª–∞—Ö, –ø–æ—Å–≤—è—â–µ–Ω–Ω—ã–µ {topic}",
        f"4. –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–π –∏ —Å–∏–º–ø–æ–∑–∏—É–º–æ–≤ –æ {topic}",
        f"5. –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-—Ä–µ—Å—É—Ä—Å—ã –∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö",
        f"6. –ê—Ä—Ö–∏–≤–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏",
        f"7. –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—á–µ—Ç—ã",
        f"8. –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ —Å–º–µ–∂–Ω—ã–º —Ç–µ–º–∞–º"
    ]
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–±—ä–µ–º–∞
    num_sources = min(pages * 3, 8)
    for i in range(num_sources):
        content.append(sources[i])
    
    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä–Ω—ã–π –æ–±—ä–µ–º
    full_text = "\n".join(content)
    char_count = len(full_text)
    word_count = len(full_text.split())
    
    content.append("")
    content.append(f"<i>–ü—Ä–∏–º–µ—Ä–Ω—ã–π –æ–±—ä–µ–º: {word_count} —Å–ª–æ–≤, {char_count} —Å–∏–º–≤–æ–ª–æ–≤</i>")
    
    return "\n".join(content)

# ============ –í–ï–ë–•–£–ö ============
@app.route('/webhook', methods=['POST'])
def webhook():
    data = request.json
    
    if "message" in data:
        msg = data["message"]
        chat_id = msg["chat"]["id"]
        text = msg.get("text", "")
        
        if text == "/start":
            reply = "‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç!\n–ü—Ä–∏–º–µ—Ä: <code>–≤–æ–π–Ω–∞ 3 –ª–∏—Å—Ç–∞</code>"
            requests.post(
                f"https://api.telegram.org/bot{TOKEN}/sendMessage",
                json={"chat_id": chat_id, "text": reply, "parse_mode": "HTML"}
            )
        else:
            # –ü–∞—Ä—Å–∏–º
            topic, volume = parse_correct(text)
            pages = int(volume) if volume.isdigit() else 3
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª
            test_msg = f"üìã <b>–†–ê–°–ü–û–ó–ù–ê–ù–û:</b>\n–¢–µ–º–∞: {topic}\n–û–±—ä–µ–º: {pages} –ª–∏—Å—Ç(–∞/–æ–≤)"
            requests.post(
                f"https://api.telegram.org/bot{TOKEN}/sendMessage",
                json={"chat_id": chat_id, "text": test_msg, "parse_mode": "HTML"}
            )
            
            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –æ–±—ä–µ–º–æ–º
            reply = generate_real_volume(topic, pages)
            requests.post(
                f"https://api.telegram.org/bot{TOKEN}/sendMessage",
                json={"chat_id": chat_id, "text": reply, "parse_mode": "HTML"}
            )
    
    return jsonify({"ok": True}), 200

@app.route('/health')
def health():
    return jsonify({"status": "ok", "bot": "@Konspekt_help_bot"})

@app.route('/')
def home():
    return "–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç! –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–±—ä–µ–º–∞."

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 8080))
    app.run(host='0.0.0.0', port=port)
