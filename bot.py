import os
import logging
from flask import Flask, request, jsonify
import requests
import random
from datetime import datetime

# ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
BOT_TOKEN = "7807343935:AAHmMbpYDssOQaAo1z3AmNEewqER97sGVNU"
PORT = 8080
APP_URL = "study-bot-render-6stk.onrender.com"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ========== FLASK APP ==========
app = Flask(__name__)

@app.route('/')
def home():
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>üéì –£—á–µ–±–Ω—ã–π –ë–æ—Ç</title>
        <style>
            body { font-family: Arial; text-align: center; padding: 50px; }
            .status { color: green; font-size: 24px; margin: 20px; }
            .btn { padding: 15px 30px; background: #0088cc; color: white; 
                   text-decoration: none; border-radius: 10px; font-size: 18px; }
        </style>
    </head>
    <body>
        <h1>üéì –£—á–µ–±–Ω—ã–π –ë–æ—Ç</h1>
        <div class="status">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</div>
        <a href="https://t.me/Konspekt_help_bot" class="btn" target="_blank">
            –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
        </a>
    </body>
    </html>
    '''

@app.route('/health')
def health():
    return jsonify({"status": "ok"}), 200

# ========== –ë–ê–ó–ê –î–ê–ù–ù–´–• –ö–û–ù–°–ü–ï–ö–¢–û–í ==========
CONSPECTS_DB = {
    "–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞": [
        "1. –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è: —á–∏—Å–ª–∞, –æ–ø–µ—Ä–∞—Ü–∏–∏, —Ñ—É–Ω–∫—Ü–∏–∏",
        "2. –ê–ª–≥–µ–±—Ä–∞: —É—Ä–∞–≤–Ω–µ–Ω–∏—è, –Ω–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–∞, —Å–∏—Å—Ç–µ–º—ã",
        "3. –ì–µ–æ–º–µ—Ç—Ä–∏—è: —Ñ–∏–≥—É—Ä—ã, —Ç–µ–æ—Ä–µ–º—ã, –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞",
        "4. –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑: –ø—Ä–µ–¥–µ–ª—ã, –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ, –∏–Ω—Ç–µ–≥—Ä–∞–ª—ã"
    ],
    "—Ñ–∏–∑–∏–∫–∞": [
        "1. –ú–µ—Ö–∞–Ω–∏–∫–∞: –¥–≤–∏–∂–µ–Ω–∏–µ, —Å–∏–ª—ã, —ç–Ω–µ—Ä–≥–∏—è",
        "2. –¢–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏–∫–∞: —Ç–µ–ø–ª–æ, —Ä–∞–±–æ—Ç–∞, —ç–Ω—Ç—Ä–æ–ø–∏—è",
        "3. –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ: —Ç–æ–∫, –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ, —Ü–µ–ø–∏",
        "4. –û–ø—Ç–∏–∫–∞: —Å–≤–µ—Ç, –ª–∏–Ω–∑—ã, –≤–æ–ª–Ω—ã"
    ],
    "–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ": [
        "1. –û—Å–Ω–æ–≤—ã: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —É—Å–ª–æ–≤–∏—è, —Ü–∏–∫–ª—ã",
        "2. –ê–ª–≥–æ—Ä–∏—Ç–º—ã: —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞, –ø–æ–∏—Å–∫, —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö",
        "3. –û–û–ü: –∫–ª–∞—Å—Å—ã, –æ–±—ä–µ–∫—Ç—ã, –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ",
        "4. –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: SQL, NoSQL, –∑–∞–ø—Ä–æ—Å—ã"
    ],
    "–∏—Å—Ç–æ—Ä–∏—è": [
        "1. –î—Ä–µ–≤–Ω–∏–π –º–∏—Ä: —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–∏, –∫—É–ª—å—Ç—É—Ä—ã",
        "2. –°—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—å–µ: —Ñ–µ–æ–¥–∞–ª–∏–∑–º, —Ä–µ–ª–∏–≥–∏—è",
        "3. –ù–æ–≤–æ–µ –≤—Ä–µ–º—è: —Ä–µ–≤–æ–ª—é—Ü–∏–∏, –∏–º–ø–µ—Ä–∏–∏",
        "4. –°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å: –≤–æ–π–Ω—ã, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏"
    ],
    "–±–∏–æ–ª–æ–≥–∏—è": [
        "1. –ö–ª–µ—Ç–æ—á–Ω–∞—è –±–∏–æ–ª–æ–≥–∏—è: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —Ñ—É–Ω–∫—Ü–∏–∏",
        "2. –ì–µ–Ω–µ—Ç–∏–∫–∞: –î–ù–ö, –Ω–∞—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –º—É—Ç–∞—Ü–∏–∏",
        "3. –≠–≤–æ–ª—é—Ü–∏—è: –≤–∏–¥—ã, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç–±–æ—Ä",
        "4. –≠–∫–æ–ª–æ–≥–∏—è: —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è"
    ]
}

# ========== –§–£–ù–ö–¶–ò–ò –ë–û–¢–ê ==========
def generate_conspect(topic):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Å–ø–µ–∫—Ç–∞ –ø–æ —Ç–µ–º–µ"""
    topic_lower = topic.lower()
    
    # –ò—â–µ–º –≤ –±–∞–∑–µ
    for key, value in CONSPECTS_DB.items():
        if key in topic_lower:
            return f"üìö *–ö–û–ù–°–ü–ï–ö–¢ –ü–û –¢–ï–ú–ï: {topic.upper()}*\n\n" + "\n".join(value)
    
    # –ï—Å–ª–∏ —Ç–µ–º—ã –Ω–µ—Ç –≤ –±–∞–∑–µ
    sections = [
        "1. *–í–≤–µ–¥–µ–Ω–∏–µ –∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è*",
        "2. *–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ*", 
        "3. *–ö–ª—é—á–µ–≤—ã–µ —Ç–µ–æ—Ä–∏–∏ –∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã*",
        "4. *–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ*",
        "5. *–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã*"
    ]
    
    return f"üìö *–ö–û–ù–°–ü–ï–ö–¢ –ü–û –¢–ï–ú–ï: {topic.upper()}*\n\n" + "\n".join(sections)

def generate_referat(topic):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞—Ç–∞"""
    structure = [
        "üìÑ *–°–¢–†–£–ö–¢–£–†–ê –†–ï–§–ï–†–ê–¢–ê:*",
        "",
        "1. *–¢–∏—Ç—É–ª—å–Ω—ã–π –ª–∏—Å—Ç*",
        "2. *–û–≥–ª–∞–≤–ª–µ–Ω–∏–µ*", 
        "3. *–í–≤–µ–¥–µ–Ω–∏–µ* (–∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å, —Ü–µ–ª–∏, –∑–∞–¥–∞—á–∏)",
        "4. *–û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å* (2-3 –≥–ª–∞–≤—ã)",
        "5. *–ó–∞–∫–ª—é—á–µ–Ω–∏–µ* (–≤—ã–≤–æ–¥—ã, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)",
        "6. *–°–ø–∏—Å–æ–∫ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã* (5-10 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)",
        "7. *–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è* (–µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ)",
        "",
        f"*–¢–µ–º–∞ —Ä–µ—Ñ–µ—Ä–∞—Ç–∞:* {topic}",
        "*–û–±—ä—ë–º:* 10-15 —Å—Ç—Ä–∞–Ω–∏—Ü",
        "*–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:* 3-5 –¥–Ω–µ–π"
    ]
    return "\n".join(structure)

def generate_plan(topic):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–∞ —Ä–∞–±–æ—Ç—ã"""
    plans = {
        "–¥–æ–∫–ª–∞–¥": ["1. –í–≤–µ–¥–µ–Ω–∏–µ", "2. –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å (3 –ø—É–Ω–∫—Ç–∞)", "3. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ", "4. –í–æ–ø—Ä–æ—Å—ã"],
        "–∫—É—Ä—Å–æ–≤–∞—è": ["1. –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è –≥–ª–∞–≤–∞", "2. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –≥–ª–∞–≤–∞", "3. –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å", "4. –í—ã–≤–æ–¥—ã"],
        "–¥–∏–ø–ª–æ–º": ["1. –í–≤–µ–¥–µ–Ω–∏–µ", "2. –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –æ–±–∑–æ—Ä", "3. –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è", "4. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã", "5. –û–±—Å—É–∂–¥–µ–Ω–∏–µ", "6. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ"]
    }
    
    for key in plans:
        if key in topic.lower():
            return f"üìã *–ü–õ–ê–ù {key.upper()} –ü–û –¢–ï–ú–ï:*\n\n" + "\n".join(plans[key])
    
    return f"üìã *–ü–õ–ê–ù –†–ê–ë–û–¢–´ –ü–û –¢–ï–ú–ï: {topic}*\n\n1. –í–≤–µ–¥–µ–Ω–∏–µ\n2. –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å\n3. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ\n4. –°–ø–∏—Å–æ–∫ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã"

def get_study_tips():
    """–°–æ–≤–µ—Ç—ã –ø–æ —É—á—ë–±–µ"""
    tips = [
        "üéØ *–°–æ–≤–µ—Ç 1:* –†–∞–∑–±–∏–≤–∞–π—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª –Ω–∞ —á–∞—Å—Ç–∏ –ø–æ 25 –º–∏–Ω—É—Ç (—Ç–µ—Ö–Ω–∏–∫–∞ Pomodoro)",
        "üìñ *–°–æ–≤–µ—Ç 2:* –ö–æ–Ω—Å–ø–µ–∫—Ç–∏—Ä—É–π—Ç–µ —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏, –∞ –Ω–µ –¥–æ—Å–ª–æ–≤–Ω–æ",
        "üîÑ *–°–æ–≤–µ—Ç 3:* –†–µ–≥—É–ª—è—Ä–Ω–æ –ø–æ–≤—Ç–æ—Ä—è–π—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª (–∫—Ä–∏–≤–∞—è –∑–∞–±—ã–≤–∞–Ω–∏—è –≠–±–±–∏–Ω–≥–∞—É–∑–∞)",
        "üß† *–°–æ–≤–µ—Ç 4:* –û–±—ä—è—Å–Ω—è–π—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª –¥—Ä—É–≥–∏–º –¥–ª—è –ª—É—á—à–µ–≥–æ –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è",
        "‚è∞ *–°–æ–≤–µ—Ç 5:* –°–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ",
        "üí§ *–°–æ–≤–µ—Ç 6:* –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –ø—Ä–æ —Å–æ–Ω - –æ–Ω –∫–æ–Ω—Å–æ–ª–∏–¥–∏—Ä—É–µ—Ç –ø–∞–º—è—Ç—å"
    ]
    return "\n\n".join(random.sample(tips, 3))

# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö –í–ï–ë–•–£–ö–ê ==========
@app.route('/' + BOT_TOKEN, methods=['POST'])
def webhook():
    """–û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫"""
    try:
        data = request.json
        
        if 'message' in data:
            chat_id = data['message']['chat']['id']
            text = data['message'].get('text', '').strip()
            username = data['message']['from'].get('first_name', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')
            
            logger.info(f"üí¨ {username}: {text}")
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
            if text == '/start':
                response = (
                    f"üëã –ü—Ä–∏–≤–µ—Ç, {username}!\n\n"
                    "üéì *–Ø ‚Äî —É—á–µ–±–Ω—ã–π –±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫*\n\n"
                    "üìö *–ß—Ç–æ —è —É–º–µ—é:*\n"
                    "‚Ä¢ –°–æ–∑–¥–∞–≤–∞—Ç—å –∫–æ–Ω—Å–ø–µ–∫—Ç—ã –ø–æ –ª—é–±–æ–π —Ç–µ–º–µ\n"
                    "‚Ä¢ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–µ—Ñ–µ—Ä–∞—Ç–æ–≤\n"
                    "‚Ä¢ –°–æ—Å—Ç–∞–≤–ª—è—Ç—å –ø–ª–∞–Ω—ã –¥–ª—è –Ω–∞—É—á–Ω—ã—Ö —Ä–∞–±–æ—Ç\n"
                    "‚Ä¢ –î–∞–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π —É—á—ë–±–µ\n\n"
                    "üí° *–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ:*\n"
                    "‚Ä¢ –¢–µ–º—É –¥–ª—è –∫–æ–Ω—Å–ø–µ–∫—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞')\n"
                    "‚Ä¢ '—Ä–µ—Ñ–µ—Ä–∞—Ç' + —Ç–µ–º–∞\n"
                    "‚Ä¢ '–ø–ª–∞–Ω' + —Ç–∏–ø —Ä–∞–±–æ—Ç—ã\n"
                    "‚Ä¢ '—Å–æ–≤–µ—Ç—ã' –¥–ª—è —Å–æ–≤–µ—Ç–æ–≤ –ø–æ —É—á—ë–±–µ\n\n"
                    "üöÄ *–ù–∞—á–Ω—ë–º? –ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç!*"
                )
                send_message(chat_id, response)
                
            elif text == '/help':
                response = (
                    "üÜò *–ü–û–ú–û–©–¨*\n\n"
                    "üìã *–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*\n"
                    "/start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É\n"
                    "/help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
                    "/tips - —Å–æ–≤–µ—Ç—ã –ø–æ —É—á—ë–±–µ\n\n"
                    "üéØ *–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:*\n"
                    "1. –î–ª—è –∫–æ–Ω—Å–ø–µ–∫—Ç–∞: –Ω–∞–ø–∏—à–∏—Ç–µ —Ç–µ–º—É\n"
                    "   –ü—Ä–∏–º–µ—Ä: '—Ñ–∏–∑–∏–∫–∞' –∏–ª–∏ '–∏—Å—Ç–æ—Ä–∏—è –¥—Ä–µ–≤–Ω–µ–≥–æ —Ä–∏–º–∞'\n\n"
                    "2. –î–ª—è —Ä–µ—Ñ–µ—Ä–∞—Ç–∞: '—Ä–µ—Ñ–µ—Ä–∞—Ç' + —Ç–µ–º–∞\n"
                    "   –ü—Ä–∏–º–µ—Ä: '—Ä–µ—Ñ–µ—Ä–∞—Ç –ø–æ –±–∏–æ–ª–æ–≥–∏–∏'\n\n"
                    "3. –î–ª—è –ø–ª–∞–Ω–∞: '–ø–ª–∞–Ω' + —Ç–∏–ø —Ä–∞–±–æ—Ç—ã\n"
                    "   –ü—Ä–∏–º–µ—Ä: '–ø–ª–∞–Ω –∫—É—Ä—Å–æ–≤–æ–π' –∏–ª–∏ '–ø–ª–∞–Ω –¥–æ–∫–ª–∞–¥–∞'\n\n"
                    "üíé *–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:*\n"
                    "‚Ä¢ '–∫–≤–∞–Ω—Ç–æ–≤–∞—è –º–µ—Ö–∞–Ω–∏–∫–∞'\n"
                    "‚Ä¢ '—Ä–µ—Ñ–µ—Ä–∞—Ç –ø–æ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–º—É –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É'\n"
                    "‚Ä¢ '–ø–ª–∞–Ω –¥–∏–ø–ª–æ–º–∞ –ø–æ —ç–∫–æ–Ω–æ–º–∏–∫–µ'\n"
                    "‚Ä¢ '—Å–æ–≤–µ—Ç—ã'"
                )
                send_message(chat_id, response)
                
            elif text == '/tips' or '—Å–æ–≤–µ—Ç' in text.lower():
                send_message(chat_id, get_study_tips())
                
            elif '—Ä–µ—Ñ–µ—Ä–∞—Ç' in text.lower():
                topic = text.lower().replace('—Ä–µ—Ñ–µ—Ä–∞—Ç', '').replace('–ø–æ', '').strip()
                if topic:
                    send_message(chat_id, generate_referat(topic))
                else:
                    send_message(chat_id, "–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–º—É –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞—Ç–∞. –ü—Ä–∏–º–µ—Ä: '—Ä–µ—Ñ–µ—Ä–∞—Ç –ø–æ –∏—Å—Ç–æ—Ä–∏–∏'")
                    
            elif '–ø–ª–∞–Ω' in text.lower():
                topic = text.lower().replace('–ø–ª–∞–Ω', '').strip()
                if topic:
                    send_message(chat_id, generate_plan(topic))
                else:
                    send_message(chat_id, "–£–∫–∞–∂–∏—Ç–µ —Ç–∏–ø —Ä–∞–±–æ—Ç—ã. –ü—Ä–∏–º–µ—Ä: '–ø–ª–∞–Ω –∫—É—Ä—Å–æ–≤–æ–π' –∏–ª–∏ '–ø–ª–∞–Ω –¥–æ–∫–ª–∞–¥–∞'")
                    
            elif len(text) > 1:
                # –û–±—ã—á–Ω—ã–π –∫–æ–Ω—Å–ø–µ–∫—Ç
                send_message(chat_id, generate_conspect(text))
                
                # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–º–æ—â—å
                if len(text.split()) <= 3:
                    time.sleep(1)
                    send_message(chat_id, 
                        f"üí° *–•–æ—Ç–∏—Ç–µ –±–æ–ª—å—à–µ?*\n\n"
                        f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
                        f"‚Ä¢ '—Ä–µ—Ñ–µ—Ä–∞—Ç –ø–æ {text}'\n"
                        f"‚Ä¢ '–ø–ª–∞–Ω –¥–æ–∫–ª–∞–¥–∞ –ø–æ {text}'\n"
                        f"‚Ä¢ '—Å–æ–≤–µ—Ç—ã –ø–æ –∏–∑—É—á–µ–Ω–∏—é {text}'"
                    )
            else:
                send_message(chat_id, 
                    "–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –∫–æ–Ω—Å–ø–µ–∫—Ç–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã:\n"
                    "‚Ä¢ /help - —Å–ø—Ä–∞–≤–∫–∞\n"
                    "‚Ä¢ /tips - —Å–æ–≤–µ—Ç—ã –ø–æ —É—á—ë–±–µ\n"
                    "‚Ä¢ '—Ä–µ—Ñ–µ—Ä–∞—Ç —Ç–µ–º–∞' - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ—Ñ–µ—Ä–∞—Ç–∞\n"
                    "‚Ä¢ '–ø–ª–∞–Ω —Ç–∏–ø_—Ä–∞–±–æ—Ç—ã' - –ø–ª–∞–Ω —Ä–∞–±–æ—Ç—ã"
                )
        
        return jsonify({"status": "ok"}), 200
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        return jsonify({"status": "error"}), 500

def send_message(chat_id, text):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram"""
    try:
        url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
        payload = {
            "chat_id": chat_id,
            "text": text,
            "parse_mode": "Markdown",
            "disable_web_page_preview": True
        }
        
        response = requests.post(url, json=payload, timeout=10)
        
        if response.status_code == 200:
            logger.info(f"üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {text[:50]}...")
        else:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {response.text}")
            
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")

# ========== –ó–ê–ü–£–°–ö ==========
if __name__ == '__main__':
    logger.info("üöÄ –£—á–µ–±–Ω—ã–π –±–æ—Ç –∑–∞–ø—É—â–µ–Ω")
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ–±—Ö—É–∫–∞
    try:
        webhook_url = f"https://{APP_URL}/{BOT_TOKEN}"
        set_url = f"https://api.telegram.org/bot{BOT_TOKEN}/setWebhook"
        requests.post(set_url, json={
            "url": webhook_url, 
            "drop_pending_updates": True,
            "allowed_updates": ["message"]
        })
        logger.info(f"‚úÖ –í–µ–±—Ö—É–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {webhook_url}")
    except Exception as e:
        logger.error(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤–µ–±—Ö—É–∫–∞: {e}")
    
    # –ó–∞–ø—É—Å–∫ Flask
    app.run(host='0.0.0.0', port=PORT, debug=False, use_reloader=False)
